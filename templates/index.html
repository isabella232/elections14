{% extends '_base.html' %}

{% block header_content %}
{% endblock %}


{% block content %}

<div class="races">
    {% for race in races %}
        <h2>{{ race.slug }}</h2>
        <div class="precincts">
            <p><strong>Precincts Reporting:</strong> <span data-field="{{ race.slug }}-precincts_reporting">{{ race.precincts_reporting }}</span></p>
            <p><strong>Precincts Total:</strong> <span data-field="{{ race.slug }}-precincts_total">{{ race.precincts_total }}</span></p>
        </div>
        <table>
            <tr>
                <th>Candidate Name</th>
                <th>Vote Count</th>
            </tr>
            {% for candidate in race.candidates %}
            <tr>
                <td>{{ candidate.first_name }} {{ candidate.last_name }}</td>
                <td data-field="{{ candidate.slug }}-vote_count">{{ candidate.vote_count }}</td>
            </tr>
            {% endfor %}
        </table>
    {% endfor %}

<a id="cast" href="#">Chromecast me!</a>
<a id="message" href="#">Say hello!</a>

{% endblock %}

{% block extra_foot %}
<script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>

<script type="text/javascript">
    var session = null;

    window['__onGCastApiAvailable'] = function(loaded, errorInfo) {
        if (loaded) {
            initializeCastApi();
        } else {
            console.log(errorInfo);
        }
    }

    var initializeCastApi = function() {
        var sessionRequest = new chrome.cast.SessionRequest('A6BCDD1E');
        var apiConfig = new chrome.cast.ApiConfig(
            sessionRequest,
            sessionListener,
            receiverListener
        );

        chrome.cast.initialize(apiConfig, onInitSuccess, onError);
    };

    function sessionListener(e) {
        session = e;
        session.addMessageListener(APP_CONFIG.CHROMECAST_NAMESPACE, receiverMessage);
    }

    function receiverMessage(namespace, message) {
        console.log('Message from receiver:', message)
    }

    function receiverListener(e) {
        if (e === chrome.cast.ReceiverAvailability.AVAILABLE) {
            console.log('available');
        } else {
            console.log('not available');
        }
    }

    function onInitSuccess(e) {
        console.log('init success');
    }

    function onError(e) {
        console.log('init error:', e);
    }

    function onSendError(message) {
        console.log(message);
    }

    function onSendSuccess(message) {
        console.log(message);
    }

    function sendMessage(message) {
        console.log(session);
        session.sendMessage(APP_CONFIG.CHROMECAST_NAMESPACE, message, onSendSuccess, onSendError);
    }

    $('#cast').click(function(e) {
        e.preventDefault();

        chrome.cast.requestSession(onRequestSessionSuccess, onLaunchError);
    });

    function onRequestSessionSuccess(e) {
        session = e;
    }

    $('#message').click(function(e) {
        e.preventDefault();

        sendMessage('hello!');
    });

    function onLaunchError(e) {
        console.log('launch error:', e);
    }
</script>
{% endblock %}

{% include '_share_modal.html' %}
